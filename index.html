import express from "express";
import axios from "axios";
import cors from "cors";

const app = express();
app.use(cors());
app.use(express.json());

let status = {
  ligado: false,
  config: null,
  simulacoes: []
};

const SCAN_INTERVAL = 15000; // 15 segundos

/* =========================
   ROTAS
========================= */

app.post("/start", (req, res) => {
  const { network, minCap, tradeValueBRL, takeProfit } = req.body;

  status.ligado = true;
  status.config = {
    network,
    minCap: Number(minCap),
    tradeValueBRL: Number(tradeValueBRL),
    takeProfit: Number(takeProfit)
  };
  status.simulacoes = [];

  res.json({
    ok: true,
    msg: "Bot ligado (dados reais)",
    config: status.config
  });
});

app.post("/stop", (req, res) => {
  status.ligado = false;
  status.config = null;
  res.json({ ok: true, msg: "Bot parado" });
});

app.get("/status", (req, res) => {
  res.json(status);
});

/* =========================
   SCAN REAL (AJUSTADO)
========================= */

async function scan() {
  if (!status.ligado || !status.config) return;

  try {
    const resp = await axios.get(
      "https://api.dexscreener.com/latest/dex/pairs/solana",
      { timeout: 10000 }
    );

    const pairs = resp.data?.pairs || [];

    for (const p of pairs) {
      if (!p?.baseToken?.symbol || !p.priceUsd) continue;

      // ðŸ”§ AJUSTE AQUI (FDV ou MarketCap ou Liquidez)
      const marketCap =
        Number(p.fdv) ||
        Number(p.marketCap) ||
        Number(p.liquidity?.usd) ||
        0;

      if (marketCap < status.config.minCap) continue;

      // evita duplicar token
      const jaExiste = status.simulacoes.find(
        s => s.address === p.baseToken.address
      );
      if (jaExiste) continue;

      const entrada = Number(p.priceUsd);
      const alvo =
        entrada * (1 + status.config.takeProfit / 100);

      status.simulacoes.unshift({
        token: p.baseToken.symbol,
        address: p.baseToken.address,
        dex: p.dexId,
        entrada,
        alvo,
        marketCap,
        horario: new Date().toISOString()
      });

      // limita histÃ³rico
      if (status.simulacoes.length > 50) {
        status.simulacoes.pop();
      }

      console.log("ðŸ“ˆ SIMULAÃ‡ÃƒO REAL:", p.baseToken.symbol);
      break; // 1 por ciclo
    }
  } catch (err) {
    console.error("Erro no scan:", err.message);
  }
}

/* =========================
   LOOP
========================= */

setInterval(scan, SCAN_INTERVAL);

/* =========================
   SERVER (RENDER)
========================= */

const PORT = process.env.PORT || 3000;
app.listen(PORT, () =>
  console.log("ðŸš€ Memebot DRY-RUN (AJUSTADO) rodando na porta", PORT)
);

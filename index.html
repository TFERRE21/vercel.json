import express from "express";
import cors from "cors";

const app = express();
app.use(cors());
app.use(express.json());

/**
 * Estado global do bot
 */
let state = {
  ligado: false,
  config: null,
  simulacoes: []
};

/**
 * Ligar bot
 */
app.post("/start", (req, res) => {
  state.ligado = true;
  state.config = req.body;
  state.simulacoes = [];

  console.log("âœ… BOT LIGADO:", state.config);

  res.json({
    ok: true,
    msg: "Bot ligado (simulaÃ§Ã£o)",
    config: state.config
  });
});

/**
 * Parar bot
 */
app.post("/stop", (req, res) => {
  state.ligado = false;

  console.log("â›” BOT PARADO");

  res.json({
    ok: true,
    msg: "Bot parado"
  });
});

/**
 * Status do bot
 */
app.get("/status", (req, res) => {
  res.json(state);
});

/**
 * ðŸ”§ SCAN â€” SIMULAÃ‡ÃƒO FAKE (TESTE CONTROLADO)
 * Roda a cada 15 segundos quando o bot estÃ¡ ligado
 */
async function scan() {
  if (!state.ligado || !state.config) return;

  const simulacaoFake = {
    token: "TEST-MEME",
    preco: 0.001,
    alvo:
      0.001 * (1 + state.config.takeProfit / 100),
    marketCap: state.config.minCap + 1000,
    horario: new Date().toISOString()
  };

  state.simulacoes.push(simulacaoFake);

  console.log("ðŸ§ª SIMULAÃ‡ÃƒO GERADA:", simulacaoFake);
}

/**
 * Loop automÃ¡tico
 */
setInterval(scan, 15000);

/**
 * Porta (Render usa PORT automaticamente)
 */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("ðŸš€ Memebot DRY-RUN ONLINE na porta", PORT);
});

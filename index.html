import express from "express";
import axios from "axios";
import cors from "cors";

const app = express();
app.use(express.json());
app.use(cors());

let state = {
  ligado: false,
  config: null,
  simulacoes: []
};

/* ---------------- START ---------------- */
app.post("/start", (req, res) => {
  state.ligado = true;
  state.config = req.body;
  state.simulacoes = [];

  console.log("ðŸŸ¢ BOT LIGADO:", state.config);

  res.json({
    ok: true,
    msg: "Bot ligado (simulaÃ§Ã£o)",
    config: state.config
  });
});

/* ---------------- STOP ---------------- */
app.post("/stop", (req, res) => {
  state.ligado = false;
  console.log("ðŸ”´ BOT PARADO");
  res.json({ ok: true });
});

/* ---------------- STATUS ---------------- */
app.get("/status", (req, res) => {
  res.json(state);
});

/* ---------------- SCAN ---------------- */
async function scan() {
  if (!state.ligado || !state.config) return;

  try {
    const r = await axios.get(
      "https://api.dexscreener.com/latest/dex/pairs/solana"
    );

    const pairs = r.data.pairs || [];

    for (const p of pairs) {
      if (
        p.fdv &&
        p.priceUsd &&
        Number(p.fdv) >= Number(state.config.minCap)
      ) {
        const simulacao = {
          token: p.baseToken.symbol,
          preco: Number(p.priceUsd),
          alvo: Number(p.priceUsd) * (1 + state.config.takeProfit / 100),
          marketCap: p.fdv,
          horario: new Date().toISOString()
        };

        state.simulacoes.push(simulacao);

        console.log("ðŸ“ˆ SIMULAÃ‡ÃƒO:", simulacao);
        break; // 1 por ciclo
      }
    }
  } catch (e) {
    console.log("âŒ Erro DexScreener:", e.message);
  }
}

/* ---------------- LOOP ---------------- */
setInterval(scan, 15000);

/* ---------------- SERVER ---------------- */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () =>
  console.log("ðŸš€ Memebot DRY-RUN rodando na porta", PORT)
);
